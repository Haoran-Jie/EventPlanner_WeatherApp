<!DOCTYPE html>
<html>

<head>
  <title>Filter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet" />

  <style>
    .button {
      border: 1px;
      background: none;
    }

    .icon {
      padding-top: 10px;
    }

    .weather-item {
      margin-top: 20px;
    }

    .sticky-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #fff;
      box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 50px;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .sticky-nav a {
      text-decoration: none;
      color: #333;
      font-size: 14px;
      font-weight: bold;
      transition: font-size 0.5s ease, color 0.3s ease;
    }

    .sticky-nav a:hover {
      color: rgb(38, 177, 195);
      font-size: 18px;
    }

    #map {
      height: calc(100vh - 350px);
      width: 90%;
      margin: 20px auto;
    }


    body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 170vh;
            background: linear-gradient(45deg, #85FFBD, #FFFB7D, #FF85E5);
            background-size: 200% 200%;
            animation: gradient 5s ease infinite;
            font-family: Arial, sans-serif;
            margin: 0;
        }

    .weather-card {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 10px;
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 20px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
      transition: transform .2s;
      min-width: 200px;
      min-height: 200px;
      margin-right: 10px;
      overflow-y: hidden;
    }

    .weather-card:hover {
      transform: scale(1.05);
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid #333;
    }

    .weather-card:hover h2,
    .weather-card:hover h3,
    .weather-card:hover p {
      font-weight: bold;
    }

    #weather-container {
      display: flex;
      overflow-x: auto;
      flex-wrap: nowrap;
      margin: 0 auto;
      width: 100%;
      padding-bottom: 20px;
    }

    #checkbutton {
      text-align: center;
      font-size: 25px;
      display: block;
      background: #191970;
      font-weight: bold;
    }
  </style>
</head>

<body style="height: 150vh;">
  <h1>Desired Weather</h1>
  <div>
    <button class="button" data-clicked="false" data-weather-type="sun"
      onclick="filterWeather('sun'); showClicked(this)">
      <img class="icon" src="https://cdn-icons-png.flaticon.com/512/831/831682.png" width="80" height="80">
      <p> Sunny </p>
    </button>
    <button class="button" data-clicked="false" data-weather-type="rainy"
      onclick="filterWeather('rainy'); showClicked(this)">
      <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1779/1779907.png" width="80" height="80">
      <p> Rainy </p>
    </button>
    <button class="button" data-clicked="false" data-weather-type="cloudy"
      onclick="filterWeather('cloudy'); showClicked(this)">
      <img class="icon" src="https://cdn-icons-png.flaticon.com/512/4343/4343597.png" width="80" height="80">
      <p> Cloudy </p>
    </button>
    <button class="button" data-clicked="false" data-weather-type="snow"
      onclick="filterWeather('snow'); showClicked(this)">
      <img class="icon" src="https://cdn-icons-png.flaticon.com/512/8675/8675121.png" width="80" height="80">
      <p> Snow </p>
    </button>
    <button class="button" data-clicked="false" data-weather-type="wind"
      onclick="filterWeather('wind'); showClicked(this)">
      <img class="icon" src="https://cdn-icons-png.flaticon.com/512/4005/4005837.png" width="80" height="80">
      <p> Wind </p>
    </button>

  </div>
  <div id="map"></div>
  <button style ="color:white; font-size: 2.0vw; font-family: Arial; font-weight: bold"; id = "checkbutton" onclick="checkRequirementsAndUpdate()">Check Requirements</button>

  <div id="weather-container">
    <!-- Weather cards will be added here -->
  </div>

  

  <div class="sticky-nav">
    <a href="/"><i class="fas fa-home"></i> Home</a>
    <a href="/filter"><i class="fas fa-tasks"></i> Plan</a>
    <a href="/setting"><i class="fas fa-cog"></i> Settings</a>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiamlhaGJvcmNuIiwiYSI6ImNsaHM3M2QzeDA4N2kzZXFnaWc5ZGU4ZGUifQ.coG9goefWIKJ8Xb1Seh3_Q';

    var bounds = [
      [-11.8, 49.6], // Southwest coordinates
      [1.8, 60.9] // Northeast coordinates
    ];

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-2.0, 55.4], // Center coordinates of the UK
      zoom: 5, // Initial zoom level
      maxBounds: bounds // Restrict the map to the specified bounds
    });

    var marker = new mapboxgl.Marker();

    map.on('click', function (e) {
      marker.setLngLat(e.lngLat).addTo(map);
    });

    // Weather data for each day, moment allows us to get current day. We can do five days in advance. 
    var weatherData = [
      { date: moment().format("DD-MM") },
      { date: moment().add(1, 'days').format("DD-MM") },
      { date: moment().add(2, 'days').format("DD-MM") },
      { date: moment().add(3, 'days').format("DD-MM") },
      { date: moment().add(4, 'days').format("DD-MM") }
    ];


    var weatherContainer = document.getElementById('weather-container');

    // Add weather cards for each day
    weatherData.forEach(function (data) {
      var card = document.createElement('div');
      card.classList.add('weather-card');

      var date = document.createElement('h2');
      date.textContent = data.date;

      card.appendChild(date);
      weatherContainer.appendChild(card);
    });


    function getWeatherIconClass(weatherType) {
      var weatherIconMap = {
        sun: 'fas fa-sun text-blue',
        rainy: 'fas fa-cloud-rain text-gray',
        cloudy: 'fas fa-cloud text-gray',
        snow: 'fas fa-snowflake text-white',
        wind: 'fas fa-wind text-yellow'
      };

      return weatherIconMap[weatherType];
    }

    function getWeatherTypeName(weatherType) {
      var weatherTypeNameMap = {
        sun: 'Sunny',
        rainy: 'Rainy',
        cloudy: 'Cloudy',
        snow: 'Snow',
        wind: 'Wind'
      };

      return weatherTypeNameMap[weatherType];
    }

    function checkRequirements(latitude, longitude, selectedWeather) {
      // Create the request body
      var requestData = {
        latitude: latitude,
        longitude: longitude,
        selectedWeather: selectedWeather
      };

      // Send an HTTP POST request to the Flask route
      fetch('/check-requirements', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      })
        .then(function (response) {
          // Parse the JSON response
          return response.json();
        })
        .then(function (result) {
          // Process the result received from the backend
          updateCardColors(result);
        })
        .catch(function (error) {
          // Handle any errors that occurred during the request
          console.error('Error:', error);
        });
    }


    function updateCardColorsAndRedirect(satisfiedRequirements, locationId) {
      var cards = document.getElementsByClassName('weather-card');

      for (var i = 0; i < cards.length; i++) {
        var card = cards[i];
        var requirementSatisfied = satisfiedRequirements[i];

        if (requirementSatisfied) {
          card.style.backgroundColor = 'green';
        } else {
          card.style.backgroundColor = 'red';
        }

        // Add click event listener to each card
        card.addEventListener('click', function () {
          // Redirect to the forecast link with the locationId and card index
          var cardIndex = Array.prototype.indexOf.call(cards, this);
          window.location.href = '/forecast/' + locationId + '/' + (cardIndex + 1);
        });
      }
    }

    function getSelectedWeather() {
      var buttons = document.getElementsByClassName('button');
      var selectedWeather = [];

      for (var i = 0; i < buttons.length; i++) {
        var button = buttons[i];

        if (button.dataset.clicked === "true") {
          selectedWeather.push(button.getAttribute('data-weather-type'));
        }
      }

      return selectedWeather;
    }

    function showClicked(button) {
      if (button.dataset.clicked === "true") {
        button.style.backgroundColor = "white";
        button.style.fontWeight = "normal";
        button.dataset.clicked = "false";
      } else {
        button.style.backgroundColor = "#F0F8FF";
        button.style.fontWeight = "bold";
        button.dataset.clicked = "true";
      }
    }

    function filterWeather(condition) {
      var weatherItems = document.getElementsByClassName('weather-item');
      for (var i = 0; i < weatherItems.length; i++) {
        var item = weatherItems[i];
        item.style.display = 'none';
      }
      var filteredItems = document.getElementsByClassName('weather-' + condition);
      for (var j = 0; j < filteredItems.length; j++) {
        var filteredItem = filteredItems[j];
        filteredItem.style.display = 'block';
      }
      var buttons = document.getElementsByClassName('button');
      for (var k = 0; k < buttons.length; k++) {
        var button = buttons[k];
        button.classList.remove('active');
      }
      event.target.classList.add('active');
    }

    function checkRequirementsAndUpdate() {
      var lngLat = marker.getLngLat();
      var selectedWeather = getSelectedWeather();

      // Call your JavaScript function and pass the latitude, longitude, and selected weather
      fetch('/check-requirements', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          latitude: lngLat.lat,
          longitude: lngLat.lng,
          selectedWeather: selectedWeather
        })
      })
        .then(function (response) {
          // Parse the JSON response
          return response.json();
        })
        .then(function (result) {
          // Process the result received from the backend
          updateCardColorsAndRedirect(result.result, result.locationId);
        })
        .catch(function (error) {
          // Handle any errors that occurred during the request
          console.error('Error:', error);
        });
    }
  </script>
</body>

</html>